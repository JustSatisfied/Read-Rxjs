name: Build and Deploy - yepengfei/demo

on:
  push:
    branches: [ "yepengfei/demo" ]  # 专门针对你的分支
  pull_request:
    branches: [ "yepengfei/demo" ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: self-hosted  # 使用你的本地Runner
    env:
      NODE_ENV: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: yepengfei/demo  # 明确指定分支

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.14'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci  # 更严格的依赖安装

    - name: Run tests
      run: npm test  # 确保你的项目有测试脚本

    - name: Build project
      run: npm run build

    - name: Deploy to local server
      run: |
        # Linux/macOS 部署
        if [ "$RUNNER_OS" == "Linux" ] || [ "$RUNNER_OS" == "macOS" ]; then
          DEPLOY_DIR="/var/www/yepengfei-demo"
          sudo mkdir -p $DEPLOY_DIR
          sudo cp -r ./dist/* $DEPLOY_DIR/
          echo "✅ Deployed to $DEPLOY_DIR"
        
        # Windows 部署
        elif [ "$RUNNER_OS" == "Windows" ]; then
          $DEPLOY_DIR = "C:\yepengfei-demo"
          if (!(Test-Path $DEPLOY_DIR)) { New-Item -ItemType Directory -Path $DEPLOY_DIR }
          Copy-Item -Path ".\dist\*" -Destination $DEPLOY_DIR -Recurse -Force
          echo "✅ Deployed to $DEPLOY_DIR"
        fi

    - name: Verify deployment
      run: |
        if [ "$RUNNER_OS" == "Linux" ] || [ "$RUNNER_OS" == "macOS" ]; then
          ls -l /var/www/yepengfei-demo
        else
          dir "C:\yepengfei-demo"
        fi